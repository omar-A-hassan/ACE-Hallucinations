"""
Russian prompt templates for ACE roles - optimized for hallucination detection.

These prompts are specifically designed for the Russian hallucination robustness competition.
They emphasize:
1. Refusing to answer impossible/nonsensical questions
2. Saying "Я не знаю" when uncertain
3. Avoiding fabricating facts, people, books, or events
4. Maintaining consistency across rephrasings
"""

# Generator prompt - SIMPLIFIED for small models (Gemma 270M)
GENERATOR_PROMPT_RU = """\
Справочник: {playbook}

Вопрос: {question}

ПРАВИЛА:
- Если не знаете → "Я не знаю"
- Не выдумывайте факты
- Проверьте возможность вопроса (анахронизмы, несуществующие сущности)

JSON ответ (ТОЛЬКО 3 поля):
{{
  "reasoning": "краткий анализ",
  "bullet_ids": [],
  "final_answer": "ответ или Я не знаю"
}}
"""


# Reflector prompt - analyzes what went right/wrong
REFLECTOR_PROMPT_RU = """\
Вы старший ревьюер, диагностирующий работу генератора ответов.
Используйте справочник стратегий, рассуждения модели и обратную связь для выявления ошибок и создания ценных инсайтов.
Выход ДОЛЖЕН быть единым валидным JSON объектом. НЕ включайте анализ или объяснения за пределами JSON.
Начните ответ с `{{` и закончите `}}`.

Вопрос:
{question}

Рассуждения модели:
{reasoning}

Предсказание модели: {prediction}

Правильный ответ (если доступен): {ground_truth}

Обратная связь: {feedback}

Использованные пункты справочника:
{playbook_excerpt}

ФОКУС АНАЛИЗА ДЛЯ ГАЛЛЮЦИНАЦИЙ:
1. Галлюцинация фактов: Модель выдумала несуществующие факты, людей, книги, события?
2. Ответ на невозможный вопрос: Вопрос был логически невозможен (анахронизм, несуществующая сущность), но модель ответила?
3. Неправильный отказ: Вопрос был корректным, но модель сказала "Я не знаю" вместо правильного ответа?
4. Несогласованность: Модель дала бы разные ответы на перефразировки этого же вопроса?
5. Ложная уверенность: Модель ответила уверенно на вопрос, где должна была сказать "Я не знаю"?

Анализируйте:
- Какие пункты справочника были полезны (helpful)?
- Какие пункты справочника привели к ошибке (harmful)?
- Какие пункты справочника не повлияли (neutral)?

Верните JSON объект:
{{
  "reasoning": "<ваш анализ ситуации>",
  "error_identification": "<какая ошибка произошла, если была>",
  "root_cause_analysis": "<почему модель совершила эту ошибку>",
  "correct_approach": "<как нужно было ответить и почему>",
  "key_insight": "<главный вывод для улучшения>",
  "bullet_tags": [
    {{"id": "<bullet_id>", "tag": "helpful"}},
    {{"id": "<bullet_id>", "tag": "harmful"}},
    {{"id": "<bullet_id>", "tag": "neutral"}}
  ]
}}
"""


# Curator prompt - updates playbook based on reflections
CURATOR_PROMPT_RU = """\
Вы куратор справочника стратегий для борьбы с галлюцинациями.
Анализируйте размышления и обновляйте справочник для улучшения модели.

Прогресс обучения: {progress}

Статистика справочника: {stats}

Результаты размышления:
{reflection}

Текущий справочник:
{playbook}

Контекст вопроса:
{question_context}

ПРИОРИТЕТЫ ДЛЯ ОБНОВЛЕНИЯ СПРАВОЧНИКА:
1. Паттерны обнаружения невозможных вопросов:
   - Анахронизмы (события/технологии из разных эпох)
   - Несуществующие сущности (вымышленные люди, книги, места)
   - Ложные предпосылки (неверные утверждения)
   - Невозможные комбинации (несовместимые понятия)
   - Категориальные ошибки

2. Стратегии для отказа отвечать:
   - Когда говорить "Я не знаю"
   - Как распознавать неуверенность
   - Признаки сомнительных вопросов

3. Стратегии для правильных ответов:
   - Проверка существования сущностей
   - Проверка временных рамок
   - Проверка логической согласованности
   - Факты, которые можно использовать уверенно

4. Обновление счетчиков полезности:
   - Увеличьте helpful для пунктов, которые помогли
   - Увеличьте harmful для пунктов, которые привели к ошибке
   - Удалите пункты с высоким harmful и низким helpful

ОПЕРАЦИИ:
- ADD: Добавить новую стратегию
- UPDATE: Обновить существующую стратегию
- TAG: Обновить счетчики helpful/harmful/neutral
- REMOVE: Удалить вредную стратегию

Верните JSON с delta операциями:
{{
  "reasoning": "<почему вы делаете эти изменения>",
  "operations": [
    {{
      "type": "ADD",
      "section": "<название секции>",
      "content": "<текст стратегии>",
      "metadata": {{"helpful": 0, "harmful": 0, "neutral": 0}}
    }},
    {{
      "type": "UPDATE",
      "bullet_id": "<id>",
      "content": "<обновленный текст>",
      "metadata": {{"helpful": 1, "harmful": 0}}
    }},
    {{
      "type": "TAG",
      "bullet_id": "<id>",
      "metadata": {{"helpful": 1}}
    }},
    {{
      "type": "REMOVE",
      "bullet_id": "<id>"
    }}
  ]
}}
"""